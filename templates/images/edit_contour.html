{% extends 'base.html' %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—É—Ä–∞: {{ image.original_filename }}{% endblock %}

{% block extra_css %}
<style>
    .canvas-container {
        position: relative;
        display: inline-block;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: auto;
        margin: 20px 0;
        max-height: 70vh;
        max-width: 100%;
        background: #f8f9fa;
    }
    
    #canvas {
        cursor: crosshair;
        display: block;
        margin: 0 auto;
    }
    
    .controls {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .btn-group {
        margin: 10px 5px;
    }
    
    .zoom-controls {
        text-align: center;
        margin: 10px 0;
    }
    
    .zoom-info {
        margin: 5px 0;
        font-weight: bold;
        color: #495057;
    }
    
    .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
    }
    
    .status.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .status.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .status.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
    
    .control-section {
        margin: 15px 0;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: white;
    }
    
    .control-section h6 {
        margin-bottom: 15px;
        color: #495057;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 5px;
    }
    
    .contour-info {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
    }
    
    .current-contour {
        font-weight: bold;
        color: #007bff;
    }
    
    .contour-list {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 5px;
    }
    
    .contour-item {
        padding: 5px 10px;
        margin: 2px 0;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid transparent;
    }
    
    .contour-item:hover {
        background: #f8f9fa;
        border-color: #dee2e6;
    }
    
    .contour-item.active {
        background: #007bff;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—É—Ä–∞: {{ image.original_filename }}</h2>
                <a href="{% url 'image_detail' image.id %}" class="btn btn-secondary">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é</a>
            </div>
        </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º -->
    <div class="row">
        <div class="col-12">
            <div class="control-section">
                <h6>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º</h6>
                <div class="zoom-controls">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary" id="zoomOutBtn">üîç-</button>
                        <button type="button" class="btn btn-outline-secondary" id="resetZoomBtn">100%</button>
                        <button type="button" class="btn btn-outline-secondary" id="zoomInBtn">üîç+</button>
                        <button type="button" class="btn btn-outline-secondary" id="fitBtn">–ü–æ —Ä–∞–∑–º–µ—Ä—É</button>
                    </div>
                    <div class="zoom-info">
                        –ú–∞—Å—à—Ç–∞–±: <span id="zoomLevel">100%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Canvas -->
    <div class="row">
        <div class="col-12 text-center">
            <div class="canvas-container" id="canvasContainer">
                <canvas id="canvas"></canvas>
            </div>
            <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤ -->
            <div class="mt-2" style="font-size: 12px; color: #666;">
                –†–∞–∑–º–µ—Ä—ã canvas: <span id="canvasSize">-</span> | 
                –†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: <span id="imageSize">-</span> |
                –ú–∞—Å—à—Ç–∞–±: <span id="currentScale">-</span>
            </div>
            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é -->
            <div class="mt-2" style="font-size: 13px; color: #495057; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> 
                –ö–ª–∏–∫ –Ω–∞ –ø—É—Å—Ç–æ–º –º–µ—Å—Ç–µ - –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É | 
                –ö–ª–∏–∫ –Ω–∞ –ª–∏–Ω–∏–∏ - –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É | 
                –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ - –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å | 
                –ö–ª–∏–∫ –Ω–∞ —Ç–æ—á–∫–µ - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–æ–Ω—Ç—É—Ä
            </div>
        </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—É—Ä–∞–º–∏ -->
    <div class="row">
        <div class="col-md-4">
            <div class="control-section">
                <h6>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—É—Ä–∞–º–∏</h6>
                <div class="contour-info">
                    <div class="current-contour">
                        –¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç—É—Ä: <span id="currentContourName">–ö–æ–Ω—Ç—É—Ä 1</span>
                    </div>
                    <div>
                        –¢–æ—á–µ–∫ –≤ –∫–æ–Ω—Ç—É—Ä–µ: <span id="currentContourPoints">0</span>
                    </div>
                    <div>
                        –í—Å–µ–≥–æ –∫–æ–Ω—Ç—É—Ä–æ–≤: <span id="totalContours">1</span>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" id="newContourBtn">–ù–æ–≤—ã–π –∫–æ–Ω—Ç—É—Ä</button>
                    <button type="button" class="btn btn-success" id="loadExistingBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π</button>
                    <button type="button" class="btn btn-warning" id="clearCurrentBtn">–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π</button>
                    <button type="button" class="btn btn-danger" id="deleteContourBtn">–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç—É—Ä</button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="control-section">
                <h6>–°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç—É—Ä–æ–≤</h6>
                <div class="contour-list" id="contourList">
                    <!-- –ö–æ–Ω—Ç—É—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="control-section">
                <h6>–î–µ–π—Å—Ç–≤–∏—è</h6>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-info" id="undoBtn">–û—Ç–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É</button>
                    <button type="button" class="btn btn-secondary" id="previewBtn">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                    <button type="button" class="btn btn-primary" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç—É—Ä—ã</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç—É—Ä–µ -->
    <div class="row">
        <div class="col-12">
            <div id="status" class="status info">
                –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...
            </div>
            
            <div id="contourInfo" class="status info" style="display: none;">
                <span id="hasExistingContour">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const canvasContainer = document.getElementById('canvasContainer');
    
    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const newContourBtn = document.getElementById('newContourBtn');
    const clearCurrentBtn = document.getElementById('clearCurrentBtn');
    const deleteContourBtn = document.getElementById('deleteContourBtn');
    const undoBtn = document.getElementById('undoBtn');
    const saveBtn = document.getElementById('saveBtn');
    const loadExistingBtn = document.getElementById('loadExistingBtn');
    const previewBtn = document.getElementById('previewBtn');
    
    // –ö–Ω–æ–ø–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const resetZoomBtn = document.getElementById('resetZoomBtn');
    const fitBtn = document.getElementById('fitBtn');
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const status = document.getElementById('status');
    const contourInfo = document.getElementById('contourInfo');
    const currentContourName = document.getElementById('currentContourName');
    const currentContourPoints = document.getElementById('currentContourPoints');
    const totalContours = document.getElementById('totalContours');
    const zoomLevel = document.getElementById('zoomLevel');
    const hasExistingContour = document.getElementById('hasExistingContour');
    const contourList = document.getElementById('contourList');
    
    // –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const canvasSize = document.getElementById('canvasSize');
    const imageSize = document.getElementById('imageSize');
    const currentScale = document.getElementById('currentScale');
    
    // –î–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä–æ–≤
    let contours = []; // –ú–∞—Å—Å–∏–≤ –∫–æ–Ω—Ç—É—Ä–æ–≤, –∫–∞–∂–¥—ã–π –∫–æ–Ω—Ç—É—Ä - –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫
    let currentContourIndex = 0;
    let isImageLoaded = false;
    let imageObj = new Image();
    let currentZoom = 1.0;
    let originalWidth = 0;
    let originalHeight = 0;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ç–æ—á–µ–∫
    let isDragging = false;
    let dragContourIndex = -1;
    let dragPointIndex = -1;
    let lastMouseX = 0;
    let lastMouseY = 0;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞
    contours.push([]);
    
    function updateDebugInfo() {
        canvasSize.textContent = `${canvas.width}x${canvas.height}`;
        imageSize.textContent = `${originalWidth}x${originalHeight}`;
        currentScale.textContent = `${currentZoom.toFixed(2)}`;
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ—á–∫–∞–º–∏
    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: (e.clientX - rect.left) / currentZoom,
            y: (e.clientY - rect.top) / currentZoom
        };
    }
    
    function distance(p1, p2) {
        return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }
    
    function findPointAt(mousePos, threshold = 8) {
        // –ò—â–µ–º —Ç–æ—á–∫—É —Ä—è–¥–æ–º —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –º—ã—à–∏
        for (let contourIndex = 0; contourIndex < contours.length; contourIndex++) {
            const contour = contours[contourIndex];
            for (let pointIndex = 0; pointIndex < contour.length; pointIndex++) {
                const point = contour[pointIndex];
                if (distance(mousePos, point) <= threshold) {
                    return { contourIndex, pointIndex };
                }
            }
        }
        return null;
    }
    
    function findLineSegmentAt(mousePos, threshold = 5) {
        // –ò—â–µ–º –ª–∏–Ω–∏—é —Ä—è–¥–æ–º —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –º—ã—à–∏ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏
        for (let contourIndex = 0; contourIndex < contours.length; contourIndex++) {
            const contour = contours[contourIndex];
            if (contour.length < 2) continue;
            
            for (let i = 0; i < contour.length; i++) {
                const p1 = contour[i];
                const p2 = contour[(i + 1) % contour.length]; // –ó–∞–º—ã–∫–∞–µ–º –∫–æ–Ω—Ç—É—Ä
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ –ª–∏–Ω–∏–∏
                const distToLine = distanceToLineSegment(mousePos, p1, p2);
                if (distToLine <= threshold) {
                    return { contourIndex, insertAfter: i };
                }
            }
        }
        return null;
    }
    
    function distanceToLineSegment(point, lineStart, lineEnd) {
        const A = point.x - lineStart.x;
        const B = point.y - lineStart.y;
        const C = lineEnd.x - lineStart.x;
        const D = lineEnd.y - lineStart.y;
        
        const dot = A * C + B * D;
        const lenSq = C * C + D * D;
        let param = -1;
        
        if (lenSq !== 0) {
            param = dot / lenSq;
        }
        
        let xx, yy;
        
        if (param < 0) {
            xx = lineStart.x;
            yy = lineStart.y;
        } else if (param > 1) {
            xx = lineEnd.x;
            yy = lineEnd.y;
        } else {
            xx = lineStart.x + param * C;
            yy = lineStart.y + param * D;
        }
        
        const dx = point.x - xx;
        const dy = point.y - yy;
        return Math.sqrt(dx * dx + dy * dy);
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    imageObj.crossOrigin = 'anonymous';
    const imageUrl = '{{ image.processed_image.url }}';
    console.log('–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å URL:', imageUrl);
    imageObj.src = imageUrl;
    
    imageObj.onload = function() {
        console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
        console.log('–†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', imageObj.width, 'x', imageObj.height);
        
        originalWidth = imageObj.width;
        originalHeight = imageObj.height;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        updateCanvasSize();
        drawImage();
        
        isImageLoaded = true;
        status.textContent = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ù–∞—á–Ω–∏—Ç–µ –∫–ª–∏–∫–∞—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç—É—Ä–∞.';
        status.className = 'status success';
        contourInfo.style.display = 'block';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        updateContourInfo();
        updateContourList();
        updateDebugInfo();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç—É—Ä
        checkExistingContour();
    };
    
    imageObj.onerror = function(error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
        console.error('URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', imageUrl);
        status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + imageUrl;
        status.className = 'status error';
    };
    
    function updateCanvasSize() {
        canvas.width = originalWidth * currentZoom;
        canvas.height = originalHeight * currentZoom;
        zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
        updateDebugInfo();
    }
    
    function drawImage() {
        if (!isImageLoaded) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(imageObj, 0, 0, canvas.width, canvas.height);
    }
    
    function drawContours() {
        drawImage();
        
        // –†–∏—Å—É–µ–º –≤—Å–µ –∫–æ–Ω—Ç—É—Ä—ã
        contours.forEach(function(contour, contourIndex) {
            if (contour.length === 0) return;
            
            // –¶–≤–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –∞–∫—Ç–∏–≤–Ω—ã–π –ª–∏ –∫–æ–Ω—Ç—É—Ä
            const isActive = contourIndex === currentContourIndex;
            const pointColor = isActive ? 'red' : 'orange';
            const lineColor = isActive ? 'red' : 'orange';
            const alpha = isActive ? 1.0 : 0.7;
            
            ctx.globalAlpha = alpha;
            ctx.fillStyle = pointColor;
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 2 * currentZoom;
            
            // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏
            contour.forEach(function(point, index) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
                if (point.x < 0 || point.x > originalWidth || point.y < 0 || point.y > originalHeight) {
                    console.warn(`–¢–æ—á–∫–∞ ${index} –≤ –∫–æ–Ω—Ç—É—Ä–µ ${contourIndex} –≤–Ω–µ –≥—Ä–∞–Ω–∏—Ü –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: (${point.x}, ${point.y}) –ø—Ä–∏ —Ä–∞–∑–º–µ—Ä–µ ${originalWidth}x${originalHeight}`);
                    return;
                }
                
                // –†–∏—Å—É–µ–º —Ç–æ—á–∫—É
                ctx.beginPath();
                ctx.arc(point.x * currentZoom, point.y * currentZoom, 4 * currentZoom, 0, 2 * Math.PI);
                ctx.fill();
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç–æ—á–∫–∏
                ctx.fillStyle = 'white';
                ctx.font = (12 * currentZoom) + 'px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(index + 1, point.x * currentZoom, point.y * currentZoom + 4 * currentZoom);
                ctx.fillStyle = pointColor;
            });
            
            // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
            if (contour.length > 1) {
                ctx.beginPath();
                const validPoints = contour.filter(p => p.x >= 0 && p.x <= originalWidth && p.y >= 0 && p.y <= originalHeight);
                if (validPoints.length > 1) {
                    ctx.moveTo(validPoints[0].x * currentZoom, validPoints[0].y * currentZoom);
                    
                    for (let i = 1; i < validPoints.length; i++) {
                        ctx.lineTo(validPoints[i].x * currentZoom, validPoints[i].y * currentZoom);
                    }
                    
                    // –ó–∞–º—ã–∫–∞–µ–º –∫–æ–Ω—Ç—É—Ä, –µ—Å–ª–∏ —Ç–æ—á–µ–∫ –±–æ–ª—å—à–µ 2
                    if (validPoints.length > 2) {
                        ctx.lineTo(validPoints[0].x * currentZoom, validPoints[0].y * currentZoom);
                    }
                    
                    ctx.stroke();
                }
            }
        });
        
        ctx.globalAlpha = 1.0;
    }
    
    function updateContourInfo() {
        const currentContour = contours[currentContourIndex] || [];
        currentContourName.textContent = `–ö–æ–Ω—Ç—É—Ä ${currentContourIndex + 1}`;
        currentContourPoints.textContent = currentContour.length;
        totalContours.textContent = contours.length;
    }
    
    function updateContourList() {
        contourList.innerHTML = '';
        contours.forEach(function(contour, index) {
            const item = document.createElement('div');
            item.className = `contour-item ${index === currentContourIndex ? 'active' : ''}`;
            item.textContent = `–ö–æ–Ω—Ç—É—Ä ${index + 1} (${contour.length} —Ç–æ—á–µ–∫)`;
            item.addEventListener('click', function() {
                currentContourIndex = index;
                updateContourInfo();
                updateContourList();
                drawContours();
            });
            contourList.appendChild(item);
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏
    canvas.addEventListener('mousedown', function(e) {
        if (!isImageLoaded) return;
        
        const mousePos = getMousePos(e);
        const foundPoint = findPointAt(mousePos);
        
        if (foundPoint) {
            // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–æ—á–∫–∏
            isDragging = true;
            dragContourIndex = foundPoint.contourIndex;
            dragPointIndex = foundPoint.pointIndex;
            currentContourIndex = foundPoint.contourIndex; // –î–µ–ª–∞–µ–º –∫–æ–Ω—Ç—É—Ä –∞–∫—Ç–∏–≤–Ω—ã–º
            lastMouseX = mousePos.x;
            lastMouseY = mousePos.y;
            canvas.style.cursor = 'grabbing';
            
            updateContourInfo();
            updateContourList();
            e.preventDefault();
        }
    });
    
    canvas.addEventListener('mousemove', function(e) {
        if (!isImageLoaded) return;
        
        const mousePos = getMousePos(e);
        
        if (isDragging && dragContourIndex >= 0 && dragPointIndex >= 0) {
            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º —Ç–æ—á–∫—É
            const contour = contours[dragContourIndex];
            if (contour && contour[dragPointIndex]) {
                contour[dragPointIndex].x = Math.round(mousePos.x);
                contour[dragPointIndex].y = Math.round(mousePos.y);
                updateContourInfo();
                updateContourList();
                drawContours();
            }
        } else {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–≤–æ–¥–∏–º—Å—è –ª–∏ –Ω–∞ —Ç–æ—á–∫—É –∏–ª–∏ –ª–∏–Ω–∏—é
            const foundPoint = findPointAt(mousePos);
            const foundLine = findLineSegmentAt(mousePos);
            
            if (foundPoint) {
                canvas.style.cursor = 'grab';
            } else if (foundLine) {
                canvas.style.cursor = 'copy';
            } else {
                canvas.style.cursor = 'crosshair';
            }
        }
    });
    
    canvas.addEventListener('mouseup', function(e) {
        if (isDragging) {
            isDragging = false;
            dragContourIndex = -1;
            dragPointIndex = -1;
            canvas.style.cursor = 'crosshair';
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ canvas
    canvas.addEventListener('click', function(e) {
        if (!isImageLoaded || isDragging) return;
        
        const mousePos = getMousePos(e);
        const foundPoint = findPointAt(mousePos);
        const foundLine = findLineSegmentAt(mousePos);
        
        if (foundPoint) {
            // –ö–ª–∏–∫ –ø–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–æ—á–∫–µ - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç—É—Ä
            currentContourIndex = foundPoint.contourIndex;
            updateContourInfo();
            updateContourList();
            drawContours();
        } else if (foundLine) {
            // –ö–ª–∏–∫ –ø–æ –ª–∏–Ω–∏–∏ - –≤—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ç–æ—á–∫—É
            const contour = contours[foundLine.contourIndex];
            const newPoint = {x: Math.round(mousePos.x), y: Math.round(mousePos.y)};
            contour.splice(foundLine.insertAfter + 1, 0, newPoint);
            
            currentContourIndex = foundLine.contourIndex;
            updateContourInfo();
            updateContourList();
            drawContours();
            
            status.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–æ—á–∫–∞ –≤ –∫–æ–Ω—Ç—É—Ä ${foundLine.contourIndex + 1}`;
            status.className = 'status success';
        } else {
            // –ö–ª–∏–∫ –≤ –ø—É—Å—Ç–æ–º –º–µ—Å—Ç–µ - –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –∫ —Ç–µ–∫—É—â–µ–º—É –∫–æ–Ω—Ç—É—Ä—É
            contours[currentContourIndex].push({x: Math.round(mousePos.x), y: Math.round(mousePos.y)});
            updateContourInfo();
            updateContourList();
            drawContours();
        }
        
        console.log('–î–µ–π—Å—Ç–≤–∏–µ:', foundPoint ? '–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç—É—Ä–∞' : foundLine ? '–í—Å—Ç–∞–≤–∫–∞ —Ç–æ—á–∫–∏' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏');
    });
    
    function checkExistingContour() {
        const existingContoursStr = '{{ contours|escapejs }}';
        const autoPointsStr = '{{ auto_contour_points|escapejs }}';
        let existingContours = [];
        let autoPoints = [];
        
        try {
            if (existingContoursStr && existingContoursStr !== '[]') {
                existingContours = JSON.parse(existingContoursStr);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç—É—Ä–æ–≤:', e);
            existingContours = [];
        }
        
        try {
            if (autoPointsStr && autoPointsStr !== '[]') {
                autoPoints = JSON.parse(autoPointsStr);
                
                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞
                if (autoPoints.length > 0) {
                    const xCoords = autoPoints.map(p => p.x);
                    const yCoords = autoPoints.map(p => p.y);
                    console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—É—Ä:');
                    console.log(`X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –º–∏–Ω=${Math.min(...xCoords)}, –º–∞–∫—Å=${Math.max(...xCoords)}`);
                    console.log(`Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –º–∏–Ω=${Math.min(...yCoords)}, –º–∞–∫—Å=${Math.max(...yCoords)}`);
                    console.log(`–†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${originalWidth}x${originalHeight}`);
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫:', e);
            autoPoints = [];
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç—É—Ä–∞—Ö
        if (existingContours && existingContours.length > 0) {
            let totalPoints = existingContours.reduce((sum, contour) => sum + contour.length, 0);
            hasExistingContour.innerHTML = `–†—É—á–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã: <span style="color: #28a745;">–ù–∞–π–¥–µ–Ω–æ ${existingContours.length} –∫–æ–Ω—Ç—É—Ä–æ–≤ (${totalPoints} —Ç–æ—á–µ–∫)</span>`;
            loadExistingBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä—É—á–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã';
            loadExistingBtn.disabled = false;
        } else if (autoPoints && autoPoints.length > 0) {
            hasExistingContour.innerHTML = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—É—Ä: <span style="color: #ffc107;">–ù–∞–π–¥–µ–Ω (${autoPoints.length} —Ç–æ—á–µ–∫)</span>`;
            loadExistingBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—É—Ä';
            loadExistingBtn.disabled = false;
        } else {
            hasExistingContour.innerHTML = '<span style="color: #dc3545;">–ö–æ–Ω—Ç—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</span>';
            loadExistingBtn.disabled = true;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç—É—Ä—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
        window.availableContours = {
            manual: existingContours,
            auto: autoPoints
        };
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞
    newContourBtn.addEventListener('click', function() {
        contours.push([]);
        currentContourIndex = contours.length - 1;
        updateContourInfo();
        updateContourList();
        drawContours();
        status.textContent = `–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—É—Ä ${currentContourIndex + 1}.`;
        status.className = 'status success';
    });
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞
    deleteContourBtn.addEventListener('click', function() {
        if (contours.length <= 1) {
            status.textContent = '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç—É—Ä.';
            status.className = 'status error';
            return;
        }
        
        contours.splice(currentContourIndex, 1);
        if (currentContourIndex >= contours.length) {
            currentContourIndex = contours.length - 1;
        }
        updateContourInfo();
        updateContourList();
        drawContours();
        status.textContent = '–ö–æ–Ω—Ç—É—Ä —É–¥–∞–ª–µ–Ω.';
        status.className = 'status info';
    });
    
    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
    zoomInBtn.addEventListener('click', function() {
        currentZoom = Math.min(currentZoom * 1.5, 5.0);
        updateCanvasSize();
        drawContours();
    });
    
    zoomOutBtn.addEventListener('click', function() {
        currentZoom = Math.max(currentZoom / 1.5, 0.1);
        updateCanvasSize();
        drawContours();
    });
    
    resetZoomBtn.addEventListener('click', function() {
        currentZoom = 1.0;
        updateCanvasSize();
        drawContours();
    });
    
    fitBtn.addEventListener('click', function() {
        const containerWidth = canvasContainer.clientWidth - 40;
        const containerHeight = canvasContainer.clientHeight - 40;
        const scaleX = containerWidth / originalWidth;
        const scaleY = containerHeight / originalHeight;
        currentZoom = Math.min(scaleX, scaleY, 1.0);
        updateCanvasSize();
        drawContours();
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞
    loadExistingBtn.addEventListener('click', function() {
        let contoursToLoad = [];
        let contourType = '';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –∫–æ–Ω—Ç—É—Ä—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å
        if (window.availableContours.manual && window.availableContours.manual.length > 0) {
            contoursToLoad = window.availableContours.manual.slice();
            contourType = '—Ä—É—á–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã';
        } else if (window.availableContours.auto && window.availableContours.auto.length > 0) {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—É—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–∫ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç—É—Ä
            contoursToLoad = [window.availableContours.auto.slice()];
            contourType = '–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—É—Ä';
        }
        
        if (contoursToLoad.length > 0) {
            // –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç—É—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏
            contours = contoursToLoad.map(contour => contour.slice());
            currentContourIndex = 0;
            updateContourInfo();
            updateContourList();
            drawContours();
            
            let totalPoints = contours.reduce((sum, contour) => sum + contour.length, 0);
            status.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω—ã ${contourType}: ${contours.length} –∫–æ–Ω—Ç—É—Ä–æ–≤ —Å ${totalPoints} —Ç–æ—á–∫–∞–º–∏.`;
            status.className = 'status success';
        } else {
            status.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–Ω—Ç—É—Ä–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.';
            status.className = 'status error';
        }
    });
    
    // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞
    clearCurrentBtn.addEventListener('click', function() {
        contours[currentContourIndex] = [];
        updateContourInfo();
        updateContourList();
        drawContours();
        status.textContent = '–¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç—É—Ä –æ—á–∏—â–µ–Ω.';
        status.className = 'status info';
    });
    
    // –û—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏
    undoBtn.addEventListener('click', function() {
        const currentContour = contours[currentContourIndex];
        if (currentContour.length > 0) {
            currentContour.pop();
            updateContourInfo();
            updateContourList();
            drawContours();
            status.textContent = '–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞.';
            status.className = 'status info';
        }
    });
    
    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
    previewBtn.addEventListener('click', function() {
        let totalPoints = 0;
        contours.forEach(contour => totalPoints += contour.length);
        
        if (totalPoints === 0) {
            status.textContent = '–ù–µ—Ç –∫–æ–Ω—Ç—É—Ä–æ–≤ –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.';
            status.className = 'status error';
            return;
        }
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
        const previewCanvas = document.createElement('canvas');
        const previewCtx = previewCanvas.getContext('2d');
        previewCanvas.width = originalWidth;
        previewCanvas.height = originalHeight;
        
        // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        previewCtx.drawImage(imageObj, 0, 0);
        
        // –†–∏—Å—É–µ–º –≤—Å–µ –∫–æ–Ω—Ç—É—Ä—ã
        contours.forEach(function(contour, contourIndex) {
            if (contour.length < 3) return;
            
            // –†–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ç—É—Ä–æ–≤
            const hue = (contourIndex * 60) % 360;
            previewCtx.fillStyle = `hsla(${hue}, 70%, 50%, 0.3)`;
            previewCtx.strokeStyle = `hsl(${hue}, 70%, 40%)`;
            previewCtx.lineWidth = 2;
            
            previewCtx.beginPath();
            previewCtx.moveTo(contour[0].x, contour[0].y);
            for (let i = 1; i < contour.length; i++) {
                previewCtx.lineTo(contour[i].x, contour[i].y);
            }
            previewCtx.closePath();
            previewCtx.fill();
            previewCtx.stroke();
        });
        
        const newWindow = window.open('', '_blank');
        newWindow.document.write('<html><head><title>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ç—É—Ä–æ–≤</title></head><body style="margin:0;padding:20px;text-align:center;"><h3>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ç—É—Ä–æ–≤</h3></body></html>');
        newWindow.document.body.appendChild(previewCanvas);
    });
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç—É—Ä–æ–≤
    saveBtn.addEventListener('click', function() {
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –∏–∑ –≤—Å–µ—Ö –∫–æ–Ω—Ç—É—Ä–æ–≤
        let allPoints = [];
        contours.forEach(function(contour, contourIndex) {
            contour.forEach(function(point) {
                allPoints.push({
                    x: point.x,
                    y: point.y,
                    contour_id: contourIndex  // –î–æ–±–∞–≤–ª—è–µ–º ID –∫–æ–Ω—Ç—É—Ä–∞
                });
            });
        });
        
        if (allPoints.length === 0) {
            status.textContent = '–ù–µ—Ç –∫–æ–Ω—Ç—É—Ä–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.';
            status.className = 'status error';
            return;
        }
        
        status.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç—É—Ä–æ–≤...';
        status.className = 'status info';
        saveBtn.disabled = true;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('{% url "save_edited_contour" image.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                points: allPoints,
                contours: contours  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–∞–∫–∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ç—É—Ä–æ–≤
            })
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                status.textContent = `–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${contours.length} –∫–æ–Ω—Ç—É—Ä–æ–≤ —Å ${allPoints.length} —Ç–æ—á–∫–∞–º–∏!`;
                status.className = 'status success';
                setTimeout(function() {
                    window.location.href = '{% url "image_detail" image.id %}';
                }, 2000);
            } else {
                status.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                status.className = 'status error';
                saveBtn.disabled = false;
            }
        })
        .catch(function(error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            status.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç—É—Ä–æ–≤.';
            status.className = 'status error';
            saveBtn.disabled = false;
        });
    });
});
</script>
{% csrf_token %}
{% endblock %} 